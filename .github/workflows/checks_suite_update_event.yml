
name: github-tasks
on:
  repository_dispatch:
    types: [checks_suite_update]
jobs:
  Checks:
    runs-on: ubuntu-latest
    steps:
      #https://github.com/actions/github-script
      #https://octokit.github.io/rest.js/v18#checks
      #https://docs.github.com/en/rest/reference/checks
      - uses: actions/github-script@v5
        with:
          script: |
            github.rest.checks.update({
              ...context.payload.client_payload,
              owner: context.repo.owner,
              repo: context.repo.repo,
            })

      # Used to send email ! :)
      # Why ? Well... by default user settings has the option
      # "Send notifications for failed workflows only" set
      # see https://github.com/settings/notifications
      - name: Invalidate worflow
        if: github.event.client_payload.conclusion == 'failure'
        uses: actions/github-script@v5
        with:
          script: |
            const { data } = await github.rest.checks.get({
              check_run_id: context.payload.client_payload.check_run_id,
              owner: context.repo.owner,
              repo: context.repo.repo,
            })
            core.notice(`commit: ${context.payload.repository.html_url}/commit/${data.head_sha}`)
            core.setFailed(`${context.payload.client_payload.output.script_name} failed see ${context.payload.repository.html_url}/runs/${context.payload.client_payload.check_run_id}`)
           
